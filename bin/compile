#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

pwd

BIN_DIR=$(dirname $0)
BUILD_DIR=$1
CACHE_DIR=$2
LP_DIR=`cd $(dirname $0); cd ..; pwd`
PHP_PATH=$BUILD_DIR/zend-server-6-php-5.4
APACHE_PATH=$BUILD_DIR/apache
NGINX_PATH=$BUILD_DIR/nginx
ZS_PATCHES="ZCLOUD-104 ZCLOUD-147"
# include .files when moving things around
shopt -s dotglob

cd $BUILD_DIR

# move app things to www
mkdir -p $CACHE_DIR/www
mv * $CACHE_DIR/www
mv $CACHE_DIR/www .

# keep Procfile
if [ -f www/Procfile ]; then
  mv www/Procfile .
fi

# Populate cache if needed
OLD_PWD=`pwd`
cd $CACHE_DIR
if [[ ! -f $CACHE_DIR/zend-server-6.2-php-5.4-nginx.tar.xz ]]; then
    curl -s -O http://repos.zend.com/cloudfoundry/zend-server-6.2-php-5.4-nginx.tar.xz
fi

for P in $ZS_PATCHES; do
    if [[ ! -f $CACHE_DIR/$P.tar.gz ]]; then
        curl -s -O http://repos.zend.com/cloudfoundry/$P.tar.gz
    fi
done

if [[ ! -f $CACHE_DIR/nginx.tar.gz ]]; then
    curl -s -O http://repos.zend.com/cloudfoundry/nginx.tar.gz
fi
cd $OLD_PWD

# Unpack Zend Server, patches and nginx
tar xJf $CACHE_DIR/zend-server-6.2-php-5.4-nginx.tar.xz
for P in $ZS_PATCHES; do
    tar xzf $CACHE_DIR/$P.tar.gz
done
tar xzf $CACHE_DIR/nginx.tar.gz

# Remove symlink to prevent errors when copying files
rm -f $PHP_PATH/bin/nginxctl.sh

# Remove DB files
rm -f $PHP_PATH/var/db/codetracing.db
rm -f $PHP_PATH/var/db/deployment.db
rm -f $PHP_PATH/var/db/gui.db
rm -f $PHP_PATH/var/db/jobqueue.db
rm -f $PHP_PATH/var/db/monitor.db
rm -f $PHP_PATH/var/db/statistics.db
rm -f $PHP_PATH/var/db/zsd.db

# Remove logs
rm -f $PHP_PATH/var/log/*
rm -f $PHP_PATH/gui/lighttpd/logs/*

# update config files
cp -rf $LP_DIR/conf/nginx/* $NGINX_PATH
mkdir -p etc
cp $LP_DIR/conf/etc/zce.rc.nginx etc/zce.rc
cp -rf $LP_DIR/conf/zend/* $PHP_PATH

# make php available on bin
mkdir -p bin
ln -s /app/zend-server-6-php-5.4/bin/php bin/php

# move json-env-extract.php into bin and make it executable
mv $LP_DIR/json-env-extract.php bin/
chmod +x bin/json-env-extract.php

mv $LP_DIR/boot.sh .
mv $LP_DIR/bootstrap.sh .
chmod +x boot.sh
chmod +x bootstrap.sh

# clean the cache
rm -rf $CACHE_DIR
